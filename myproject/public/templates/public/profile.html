{% extends 'public/P_base.html' %}
{% load static %}

{% block title %}Manage Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="profile-container">
  <div class="profile-header">
    <h1>
      <img src="{% static 'icons/user.png' %}" alt="Profile" class="page-icon">
      Manage Profile
    </h1>
  </div>

  <div class="profile-card">
    {% if messages %}
      {% for message in messages %}
        <div class="form-success">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if error %}
      <div class="form-error">{{ error }}</div>
    {% endif %}

    <form method="post" action="{% url 'public:profile' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-sections-container">
        <!-- Account Information -->
        <div class="form-section">
          <h3>Account Information</h3>
          
          <label for="id_email">Email</label>
          <input class="input-border" type="email" id="id_email" name="email" placeholder="Enter your Email" value="{{ email }}" required>

          <label for="id_first_name">First Name</label>
          <input class="input-border" type="text" id="id_first_name" name="first_name" placeholder="First Name" value="{{ first_name }}" required>

          <label for="id_last_name">Last Name</label>
          <input class="input-border" type="text" id="id_last_name" name="last_name" placeholder="Last Name" value="{{ last_name }}" required>
        </div>

        <!-- Student Information -->
        <div class="form-section">
          <h3>Student Information</h3>
          
          <label for="id_student_id">Student ID</label>
          <input class="input-border" type="text" id="id_student_id" name="student_id" placeholder="Student ID" value="{{ student_id }}" required>

          <label for="id_college">College</label>
          <select class="input-border" id="id_college" name="college" required onchange="updateCourses()">
            <option value="">Select College</option>
            <option value="College of Arts & Sciences" {% if college == 'College of Arts & Sciences' %}selected{% endif %}>College of Arts & Sciences</option>
            <option value="College of Business Management & Accountancy" {% if college == 'College of Business Management & Accountancy' %}selected{% endif %}>College of Business Management & Accountancy</option>
            <option value="College of Computer Studies" {% if college == 'College of Computer Studies' %}selected{% endif %}>College of Computer Studies</option>
            <option value="College of Education" {% if college == 'College of Education' %}selected{% endif %}>College of Education</option>
            <option value="College of Engineering" {% if college == 'College of Engineering' %}selected{% endif %}>College of Engineering</option>
            <option value="College of Industrial Technology" {% if college == 'College of Industrial Technology' %}selected{% endif %}>College of Industrial Technology</option>
          </select>

          <label for="id_course">Course</label>
          <select class="input-border" id="id_course" name="course" required>
            <option value="">Select College first</option>
          </select>

          <label for="id_year_level">Year Level</label>
          <select class="input-border" id="id_year_level" name="year_level">
            <option value="">Select Year Level</option>
            <option value="1st Year" {% if year_level == '1st Year' %}selected{% endif %}>1st Year</option>
            <option value="2nd Year" {% if year_level == '2nd Year' %}selected{% endif %}>2nd Year</option>
            <option value="3rd Year" {% if year_level == '3rd Year' %}selected{% endif %}>3rd Year</option>
            <option value="4th Year" {% if year_level == '4th Year' %}selected{% endif %}>4th Year</option>
            <option value="5th Year" {% if year_level == '5th Year' %}selected{% endif %}>5th Year</option>
          </select>

          <label for="id_profile_picture">Profile Picture</label>
          <input class="input-border" type="file" id="id_profile_picture" name="profile_picture" accept="image/*" onchange="validateFileSize(this)">
          <small class="italic-text" style="display: block; margin-top: 5px; color: #666;">Maximum file size: 2 MB. Leave empty to keep current picture.</small>
          <small id="file-size-error" style="display: none; color: #dc3545; margin-top: 5px;"></small>
        </div>
      </div>

      <!-- Password Change Section -->
      <div class="form-section password-section">
        <h3>Change Password (Optional)</h3>
        <p class="section-note">Leave password fields empty if you don't want to change your password.</p>
        
        <div class="password-fields">
          <div class="form-group">
            <label for="id_current_password">Current Password</label>
            <input class="input-border" type="password" id="id_current_password" name="current_password" placeholder="Enter current password">
          </div>

          <div class="form-group">
            <label for="id_new_password">New Password</label>
            <input class="input-border" type="password" id="id_new_password" name="new_password" placeholder="Enter new password">
          </div>

          <div class="form-group">
            <label for="id_confirm_password">Confirm New Password</label>
            <input class="input-border" type="password" id="id_confirm_password" name="confirm_password" placeholder="Confirm new password">
          </div>
        </div>
      </div>

      <button type="submit" class="btn-save" id="submit-btn">Save Changes</button>
    </form>
  </div>
</div>

<script>
  function validateFileSize(input) {
    const fileError = document.getElementById('file-size-error');
    const submitBtn = document.getElementById('submit-btn');
    
    if (input.files && input.files[0]) {
      const fileSize = input.files[0].size;
      const maxSize = 2 * 1024 * 1024; // 2 MB
      const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
      
      if (fileSize > maxSize) {
        fileError.textContent = `File is too large (${fileSizeMB} MB). Please select an image smaller than 2 MB.`;
        fileError.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
        input.value = '';
      } else {
        fileError.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
      }
    }
  }

  const coursesByCollege = {
    "College of Arts & Sciences": [
      "Bachelor of Arts in English Language",
      "Bachelor of Arts in Social Science",
      "Bachelor of Public Administration",
      "Bachelor of Science in Applied Mathematics",
      "Bachelor of Science in Psychology"
    ],
    "College of Business Management & Accountancy": [
      "Bachelor of Science in Hospitality Management"
    ],
    "College of Computer Studies": [
      "Bachelor of Science in Information Systems"
    ],
    "College of Education": [
      "Bachelor of Early Childhood Education",
      "Bachelor of Elementary Education",
      "Bachelor of Physical Education",
      "Bachelor of Secondary Education, major in English",
      "Bachelor of Secondary Education, major in Filipino",
      "Bachelor of Secondary Education, major in Mathematics",
      "Bachelor of Secondary Education, major in Science",
      "Bachelor of Special Needs Education",
      "Bachelor of Technology & Livelihood Education, major in Home Economics"
    ],
    "College of Engineering": [
      "Bachelor of Science in Civil Engineering"
    ],
    "College of Industrial Technology": [
      "Bachelor of Science in Industrial Technology, major in Architectural Drafting Technology",
      "Bachelor of Science in Industrial Technology, major in Automotive Technology",
      "Bachelor of Science in Industrial Technology, major in Electrical Technology",
      "Bachelor of Science in Industrial Technology, major in Electronics Technology",
      "Bachelor of Science in Industrial Technology, major in Apparel & Fashion Technology",
      "Bachelor of Science in Industrial Technology, major in Food Trades/Technology",
      "Bachelor of Science in Industrial Technology, major in Mechanical Technology",
      "Bachelor of Science in Industrial Technology, major in Heating, Ventilating, Air-Conditioning & Refrigeration Technology (RAC)"
    ]
  };

  function updateCourses() {
    const collegeSelect = document.getElementById('id_college');
    const courseSelect = document.getElementById('id_course');
    const selectedCollege = collegeSelect.value;

    courseSelect.innerHTML = '<option value="">Select Course</option>';

    if (selectedCollege && coursesByCollege[selectedCollege]) {
      coursesByCollege[selectedCollege].forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        courseSelect.appendChild(option);
      });
    } else {
      courseSelect.innerHTML = '<option value="">Select College first</option>';
    }
    
    // Re-select previous course if available
    const prevCourse = "{{ course|default:'' }}";
    if (prevCourse) {
      courseSelect.value = prevCourse;
    }
  }
  
  document.addEventListener('DOMContentLoaded', updateCourses);
</script>
{% endblock %}

