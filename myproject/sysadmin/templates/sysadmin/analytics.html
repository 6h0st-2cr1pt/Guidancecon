{% extends 'sysadmin/base.html' %}
{% load static %}
{% block title %}Analytics{% endblock %}
{% block extra_css %}
<style>
  .analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }
  
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .kpi-card {
    background: white;
    border: 2px solid var(--dark-green);
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .kpi-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }
  
  .kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark-green);
    margin-bottom: 4px;
  }
  
  .kpi-label {
    font-size: 0.9rem;
    color: var(--text-dark);
    font-weight: 500;
    opacity: 0.8;
  }
  
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .chart-card {
    background: white;
    border: 2px solid var(--dark-green);
    border-radius: 8px;
    padding: 24px;
    box-shadow: var(--shadow);
  }
  
  .chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-green);
    margin-bottom: 16px;
    text-align: center;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
  }
  
  @media (max-width: 768px) {
    .analytics-container {
      padding: 16px;
    }

    .page-title {
      font-size: 1.5rem;
    }

    .kpi-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .kpi-card {
      padding: 16px;
    }

    .kpi-value {
      font-size: 1.5rem;
    }

    .kpi-label {
      font-size: 0.85rem;
    }

    .charts-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .chart-card {
      padding: 16px;
    }

    .chart-title {
      font-size: 1rem;
    }

    .chart-container {
      height: 250px;
    }
  }

  @media (max-width: 480px) {
    .analytics-container {
      padding: 12px;
    }

    .page-title {
      font-size: 1.3rem;
    }

    .kpi-grid {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .kpi-card {
      padding: 12px;
    }

    .kpi-value {
      font-size: 1.3rem;
    }

    .kpi-label {
      font-size: 0.8rem;
    }

    .charts-grid {
      gap: 12px;
    }

    .chart-card {
      padding: 12px;
    }

    .chart-title {
      font-size: 0.95rem;
    }

    .chart-container {
      height: 200px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
  <h2 class="page-title">
    <img src="{% static 'icons/analytics.png' %}" alt="Analytics" style="width: 20px; height: 20px;">
    Analytics Dashboard
  </h2>
  
  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-value">{{ total_appointments }}</div>
      <div class="kpi-label">Total Appointments</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ pending_count }}</div>
      <div class="kpi-label">Pending</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ confirmed_count }}</div>
      <div class="kpi-label">Confirmed</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ completed_count }}</div>
      <div class="kpi-label">Completed</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ cancelled_count }}</div>
      <div class="kpi-label">Cancelled</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ completion_rate }}%</div>
      <div class="kpi-label">Completion Rate</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ cancellation_rate }}%</div>
      <div class="kpi-label">Cancellation Rate</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ utilization_rate }}%</div>
      <div class="kpi-label">Utilization Rate</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value">{{ recent_activity_count }}</div>
      <div class="kpi-label">Last 30 Days</div>
    </div>
  </div>
  
  <!-- Charts -->
  <div class="charts-grid">
    <!-- Status Distribution Pie Chart -->
    <div class="chart-card">
      <h3 class="chart-title">Status Distribution</h3>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
    
    <!-- Monthly Trend Line Chart -->
    <div class="chart-card">
      <h3 class="chart-title">Monthly Trend</h3>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
    
    <!-- Popular Time Slots Bar Chart -->
    <div class="chart-card">
      <h3 class="chart-title">Popular Time Slots</h3>
      <div class="chart-container">
        <canvas id="timeslotChart"></canvas>
      </div>
    </div>
    
    <!-- Students Bar Chart -->
    <div class="chart-card">
      <h3 class="chart-title">Top Students</h3>
      <div class="chart-container">
        <canvas id="studentChart"></canvas>
      </div>
    </div>
    
    <!-- Programs Bar Chart -->
    <div class="chart-card">
      <h3 class="chart-title">Appointments by Program</h3>
      <div class="chart-container">
        <canvas id="programChart"></canvas>
      </div>
    </div>

    <!-- Gender Distribution -->
    <div class="chart-card">
      <h3 class="chart-title">Student Gender Distribution</h3>
      <div class="chart-container">
        <canvas id="genderChart"></canvas>
      </div>
    </div>

    <!-- Age Groups -->
    <div class="chart-card">
      <h3 class="chart-title">Student Age Groups</h3>
      <div class="chart-container">
        <canvas id="ageChart"></canvas>
      </div>
    </div>
    
    <!-- Capacity Utilization -->
    <div class="chart-card">
      <h3 class="chart-title">Capacity Utilization</h3>
      <div style="display: flex; flex-direction: column; gap: 16px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600;">Available Slots:</span>
          <span style="font-size: 1.2rem; font-weight: 700; color: var(--dark-green);">{{ available_timeslots }}</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600;">Booked Slots:</span>
          <span style="font-size: 1.2rem; font-weight: 700; color: var(--dark-green);">{{ booked_timeslots }}</span>
        </div>
        <div style="height: 40px; background: var(--light-gray); border-radius: 8px; position: relative; overflow: hidden;">
          <div style="height: 100%; width: {{ utilization_rate }}%; background: var(--dark-green); transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-weight: 600; font-size: 0.9rem;">{{ utilization_rate }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
  // Status Distribution Pie Chart
  const statusLabels = {{ status_labels|safe }};
  const statusCounts = {{ status_counts|safe }};
  const statusColors = ['#ff6b35', '#1a4d3a', '#2d5a47', '#d32f2f', '#1976d2'];
  
  new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusCounts,
        backgroundColor: statusColors.slice(0, statusLabels.length),
        borderWidth: 2,
        borderColor: 'white'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  // Monthly Trend Line Chart
  const monthlyLabels = {{ monthly_labels|safe }};
  const monthlyData = {{ monthly_data|safe }};
  
  new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: monthlyLabels,
      datasets: [{
        label: 'Appointments',
        data: monthlyData,
        borderColor: '#1a4d3a',
        backgroundColor: 'rgba(26, 77, 58, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
  
  // Popular Time Slots Bar Chart
  const timeslotLabels = {{ timeslot_labels|safe }};
  const timeslotCounts = {{ timeslot_counts|safe }};
  
  new Chart(document.getElementById('timeslotChart'), {
    type: 'bar',
    data: {
      labels: timeslotLabels,
      datasets: [{
        label: 'Appointments',
        data: timeslotCounts,
        backgroundColor: '#1a4d3a'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
  
  // Students Bar Chart
  const studentLabels = {{ counselor_labels|safe }};
  const studentCounts = {{ counselor_counts|safe }};
  
  new Chart(document.getElementById('studentChart'), {
    type: 'bar',
    data: {
      labels: studentLabels,
      datasets: [{
        label: 'Appointments',
        data: studentCounts,
        backgroundColor: '#2d5a47'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
  
  // Programs Bar Chart
  const programLabels = {{ program_labels|safe }};
  const programCounts = {{ program_counts|safe }};
  
  new Chart(document.getElementById('programChart'), {
    type: 'bar',
    data: {
      labels: programLabels,
      datasets: [{
        label: 'Appointments',
        data: programCounts,
        backgroundColor: '#F0DF10'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });

  // Gender Distribution Pie Chart
  const genderLabels = {{ gender_labels|safe }};
  const genderCounts = {{ gender_counts|safe }};
  const genderColors = ['#1976d2', '#d81b60', '#9e9e9e', '#43a047'];

  new Chart(document.getElementById('genderChart'), {
    type: 'doughnut',
    data: {
      labels: genderLabels,
      datasets: [{
        data: genderCounts,
        backgroundColor: genderColors.slice(0, genderLabels.length),
        borderWidth: 2,
        borderColor: 'white'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // Age Groups Bar Chart
  const ageLabels = {{ age_labels|safe }};
  const ageCounts = {{ age_counts|safe }};

  new Chart(document.getElementById('ageChart'), {
    type: 'bar',
    data: {
      labels: ageLabels,
      datasets: [{
        label: 'Students',
        data: ageCounts,
        backgroundColor: '#6a994e'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
</script>
{% endblock %}

